<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Employee Management System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { margin: 0; }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-container {
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .nav-tabs {
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
        }

        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            background: none;
            border: none;
            font-size: 16px;
        }

        .nav-tab:hover {
            background: #f8f9fa;
        }

        .nav-tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .content-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
        }

        .content-section.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #667eea;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        button {
            margin: 2px;
            padding: 8px 12px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            transition: background 0.3s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a67d8;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-success:hover {
            background: #229954;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        .btn-warning:hover {
            background: #e67e22;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .btn-info {
            background: #3498db;
            color: white;
        }
        .btn-info:hover {
            background: #2980b9;
        }

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .error {
            color: #e74c3c;
            background: #ffe6e6;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .success {
            color: #27ae60;
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .quick-actions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .quick-actions h3 {
            margin-top: 0;
            color: #333;
        }

        .attendance-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .status-PRESENT { background: #d4edda; color: #155724; }
        .status-ABSENT { background: #f8d7da; color: #721c24; }
        .status-LATE { background: #fff3cd; color: #856404; }
        .status-HALF_DAY { background: #d1ecf1; color: #0c5460; }
        .status-LEAVE { background: #e2e3e5; color: #383d41; }

        .filters {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                overflow-x: auto;
            }
            .form-row {
                flex-direction: column;
            }
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
<div class="header">
    <h1>Employee Management System</h1>
    <div class="user-info">
        <span>Welcome, <strong id="currentUser">Loading...</strong></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
</div>

<div class="nav-container">
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showSection('employees')">Employees</button>
        <button class="nav-tab" onclick="showSection('attendance')">Attendance</button>
        <button class="nav-tab" onclick="showSection('reports')">Reports</button>
    </div>
</div>

<div class="container">
    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>
    <div id="loadingMessage" class="loading" style="display: none;">Loading...</div>

    <!-- Employees Section -->
    <div id="employees-section" class="content-section active">
        <h2>Employee Management</h2>

        <table>
            <thead>
            <tr>
                <th>ID</th><th>Name</th><th>Email</th><th>Designation</th>
                <th>Department</th><th>Phone</th><th>Salary</th><th>Actions</th>
            </tr>
            </thead>
            <tbody id="employeeTable"></tbody>
        </table>

        <h3 id="employeeFormTitle">Add New Employee</h3>
        <form id="employeeForm">
            <input type="hidden" id="empId">
            <div class="form-row">
                <div class="form-group">
                    <label for="name">Name *</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="designation">Designation</label>
                    <input type="text" id="designation">
                </div>
                <div class="form-group">
                    <label for="department">Department</label>
                    <input type="text" id="department">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="phone">Phone</label>
                    <input type="text" id="phone">
                </div>
                <div class="form-group">
                    <label for="salary">Salary</label>
                    <input type="number" id="salary">
                </div>
            </div>
            <button type="submit" class="btn-success">Save Employee</button>
        </form>
    </div>

    <!-- Attendance Section -->
    <div id="attendance-section" class="content-section">
        <h2>Attendance Management</h2>

        <div class="quick-actions">
            <h3>Quick Actions</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="quickEmployeeSelect">Select Employee</label>
                    <select id="quickEmployeeSelect">
                        <option value="">Choose employee...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <div>
                        <button onclick="quickCheckIn()" class="btn-success">Check In</button>
                        <button onclick="quickCheckOut()" class="btn-warning">Check Out</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="filters">
            <h3>Filters</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="attendanceDateFilter">Date</label>
                    <input type="date" id="attendanceDateFilter">
                </div>
                <div class="form-group">
                    <label for="attendanceEmployeeFilter">Employee</label>
                    <select id="attendanceEmployeeFilter">
                        <option value="">All employees</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <div>
                        <button onclick="loadAttendanceRecords()" class="btn-primary">Filter</button>
                        <button onclick="loadTodayAttendance()" class="btn-info">Today</button>
                    </div>
                </div>
            </div>
        </div>

        <table>
            <thead>
            <tr>
                <th>Date</th><th>Employee</th><th>Check In</th><th>Check Out</th>
                <th>Status</th><th>Total Hours</th><th>Notes</th><th>Actions</th>
            </tr>
            </thead>
            <tbody id="attendanceTable"></tbody>
        </table>

        <h3 id="attendanceFormTitle">Mark Attendance</h3>
        <form id="attendanceForm">
            <input type="hidden" id="attendanceId">
            <div class="form-row">
                <div class="form-group">
                    <label for="attendanceEmployee">Employee *</label>
                    <select id="attendanceEmployee" required>
                        <option value="">Select employee...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="attendanceDate">Date *</label>
                    <input type="date" id="attendanceDate" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="checkInTime">Check In Time</label>
                    <input type="time" id="checkInTime">
                </div>
                <div class="form-group">
                    <label for="checkOutTime">Check Out Time</label>
                    <input type="time" id="checkOutTime">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="attendanceStatus">Status</label>
                    <select id="attendanceStatus">
                        <option value="">Auto-determine</option>
                        <option value="PRESENT">Present</option>
                        <option value="ABSENT">Absent</option>
                        <option value="LATE">Late</option>
                        <option value="HALF_DAY">Half Day</option>
                        <option value="LEAVE">Leave</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="attendanceNotes">Notes</label>
                    <textarea id="attendanceNotes" rows="3"></textarea>
                </div>
            </div>
            <button type="submit" class="btn-success">Save Attendance</button>
        </form>
    </div>

    <!-- Reports Section -->
    <div id="reports-section" class="content-section">
        <h2>Attendance Reports</h2>

        <div class="filters">
            <h3>Generate Report</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="reportEmployee">Employee</label>
                    <select id="reportEmployee">
                        <option value="">Select employee...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reportStartDate">Start Date</label>
                    <input type="date" id="reportStartDate">
                </div>
                <div class="form-group">
                    <label for="reportEndDate">End Date</label>
                    <input type="date" id="reportEndDate">
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button onclick="generateReport()" class="btn-primary">Generate Report</button>
                </div>
            </div>
        </div>

        <div id="reportResults" style="display: none;">
            <div class="stats-grid" id="reportStats"></div>
            <table>
                <thead>
                <tr>
                    <th>Date</th><th>Check In</th><th>Check Out</th>
                    <th>Status</th><th>Total Hours</th><th>Notes</th>
                </tr>
                </thead>
                <tbody id="reportTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const apiUrl = "/api/employees";
    const attendanceApiUrl = "/api/attendance";

    let isAuthenticated = false;
    let employees = [];
    let currentSection = 'employees';

    // Utility function to format time (remove seconds)
    function formatTime(timeString) {
        if (!timeString) return '-';
        // Handle both HH:MM:SS and HH:MM formats
        const parts = timeString.split(':');
        if (parts.length >= 2) {
            return `${parts[0]}:${parts[1]}`;
        }
        return timeString;
    }

    // Utility function to format hours with minutes
    function formatHours(totalHours) {
        if (!totalHours || totalHours === 0) return '-';

        const hours = Math.floor(totalHours);
        const minutes = Math.round((totalHours - hours) * 60);

        if (hours === 0) {
            return `${minutes}m`;
        } else if (minutes === 0) {
            return `${hours}h`;
        } else {
            return `${hours}h ${minutes}m`;
        }
    }

    // Authentication and initialization
    async function checkAuth() {
        const token = localStorage.getItem('jwt');
        const username = localStorage.getItem('username');

        if (!token || !username) {
            redirectToLogin();
            return false;
        }

        try {
            const response = await fetch('/api/auth/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const userData = await response.json();
                document.getElementById('currentUser').textContent = userData.username || username;
                isAuthenticated = true;
                return true;
            } else {
                clearAuthStorage();
                redirectToLogin();
                return false;
            }
        } catch (error) {
            clearAuthStorage();
            redirectToLogin();
            return false;
        }
    }

    function getAuthHeaders() {
        return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('jwt')}`
        };
    }

    function clearAuthStorage() {
        localStorage.removeItem('jwt');
        localStorage.removeItem('username');
        isAuthenticated = false;
    }

    function redirectToLogin() {
        window.location.replace('/login.html?clear=true');
    }

    function logout() {
        clearAuthStorage();
        window.location.href = '/login.html';
    }

    // UI Functions
    function showSection(section) {
        // Update nav tabs
        document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');

        // Update content sections
        document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
        document.getElementById(section + '-section').classList.add('active');

        currentSection = section;

        // Load appropriate data
        if (section === 'employees') {
            loadEmployees();
        } else if (section === 'attendance') {
            loadTodayAttendance();
            loadEmployeeOptions();
        } else if (section === 'reports') {
            loadEmployeeOptions();
        }
    }

    function showMessage(message, type) {
        const errorEl = document.getElementById('errorMessage');
        const successEl = document.getElementById('successMessage');

        errorEl.style.display = 'none';
        successEl.style.display = 'none';

        if (type === 'error') {
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => errorEl.style.display = 'none', 5000);
        } else {
            successEl.textContent = message;
            successEl.style.display = 'block';
            setTimeout(() => successEl.style.display = 'none', 3000);
        }
    }

    function showLoading(show) {
        document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
    }

    // Employee Management
    async function loadEmployees() {
        if (!isAuthenticated) return;

        showLoading(true);
        try {
            const response = await fetch(apiUrl, { headers: getAuthHeaders() });
            const data = await response.json();

            if (!response.ok) {
                showMessage(data.error || 'Failed to load employees', 'error');
                return;
            }

            employees = data;
            const tableBody = document.getElementById('employeeTable');
            tableBody.innerHTML = '';

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">No employees found.</td></tr>';
            } else {
                data.forEach(emp => {
                    const row = `<tr>
                        <td>${emp.id}</td>
                        <td>${emp.name || ''}</td>
                        <td>${emp.email || ''}</td>
                        <td>${emp.designation || ''}</td>
                        <td>${emp.department || ''}</td>
                        <td>${emp.phone || ''}</td>
                        <td>${emp.salary ? emp.salary.toLocaleString() : '0'}</td>
                        <td>
                            <button class="btn-info" onclick="editEmployee(${emp.id})">Edit</button>
                            <button class="btn-danger" onclick="deleteEmployee(${emp.id})">Delete</button>
                        </td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });
            }
        } catch (error) {
            showMessage('Failed to load employees', 'error');
        } finally {
            showLoading(false);
        }
    }

    // Employee form handling
    document.getElementById('employeeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthenticated) return;

        const empId = document.getElementById('empId').value;
        const employee = {
            name: document.getElementById('name').value.trim(),
            email: document.getElementById('email').value.trim(),
            designation: document.getElementById('designation').value.trim(),
            department: document.getElementById('department').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            salary: parseFloat(document.getElementById('salary').value) || 0
        };

        if (!employee.name || !employee.email) {
            showMessage('Name and email are required', 'error');
            return;
        }

        try {
            const url = empId ? `${apiUrl}/${empId}` : apiUrl;
            const method = empId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers: getAuthHeaders(),
                body: JSON.stringify(employee)
            });

            const data = await response.json();

            if (!response.ok) {
                showMessage(data.error || 'Failed to save employee', 'error');
                return;
            }

            showMessage('Employee saved successfully', 'success');
            document.getElementById('employeeForm').reset();
            document.getElementById('empId').value = '';
            document.getElementById('employeeFormTitle').textContent = 'Add New Employee';
            loadEmployees();
        } catch (error) {
            showMessage('Failed to save employee', 'error');
        }
    });

    function editEmployee(id) {
        const emp = employees.find(e => e.id === id);
        if (!emp) return;

        document.getElementById('empId').value = emp.id;
        document.getElementById('name').value = emp.name || '';
        document.getElementById('email').value = emp.email || '';
        document.getElementById('designation').value = emp.designation || '';
        document.getElementById('department').value = emp.department || '';
        document.getElementById('phone').value = emp.phone || '';
        document.getElementById('salary').value = emp.salary || '';
        document.getElementById('employeeFormTitle').textContent = 'Update Employee';
    }

    async function deleteEmployee(id) {
        if (!confirm('Are you sure you want to delete this employee?')) return;

        try {
            const response = await fetch(`${apiUrl}/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                const data = await response.json();
                showMessage(data.error || 'Failed to delete employee', 'error');
                return;
            }

            showMessage('Employee deleted successfully', 'success');
            loadEmployees();
        } catch (error) {
            showMessage('Failed to delete employee', 'error');
        }
    }

    // Attendance Management
    async function loadEmployeeOptions() {
        if (employees.length === 0) {
            try {
                const response = await fetch(apiUrl, { headers: getAuthHeaders() });
                if (response.ok) {
                    employees = await response.json();
                }
            } catch (error) {
                console.error('Failed to load employees for options');
                return;
            }
        }

        const selects = ['quickEmployeeSelect', 'attendanceEmployeeFilter', 'attendanceEmployee', 'reportEmployee'];
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            select.innerHTML = selectId.includes('Filter') || selectId.includes('report') ?
                '<option value="">All employees</option>' : '<option value="">Choose employee...</option>';

            employees.forEach(emp => {
                select.innerHTML += `<option value="${emp.id}">${emp.name}</option>`;
            });

            select.value = currentValue;
        });
    }

    async function loadTodayAttendance() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('attendanceDateFilter').value = today;
        document.getElementById('attendanceDate').value = today;
        await loadAttendanceRecords();
    }

    async function loadAttendanceRecords() {
        if (!isAuthenticated) return;

        showLoading(true);
        try {
            const date = document.getElementById('attendanceDateFilter').value;
            const employeeId = document.getElementById('attendanceEmployeeFilter').value;

            let url = attendanceApiUrl;
            if (date && employeeId) {
                url = `${attendanceApiUrl}/employee/${employeeId}/date/${date}`;
            } else if (date) {
                url = `${attendanceApiUrl}/date/${date}`;
            } else if (employeeId) {
                url = `${attendanceApiUrl}/employee/${employeeId}`;
            } else {
                url = `${attendanceApiUrl}/today`;
            }

            const response = await fetch(url, { headers: getAuthHeaders() });
            let data = await response.json();

            if (!response.ok) {
                if (response.status === 404) {
                    data = [];
                } else {
                    showMessage(data.error || 'Failed to load attendance records', 'error');
                    return;
                }
            }

            // Ensure data is array
            if (!Array.isArray(data)) {
                data = [data];
            }

            const tableBody = document.getElementById('attendanceTable');
            tableBody.innerHTML = '';

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">No attendance records found.</td></tr>';
            } else {
                data.forEach(att => {
                    const row = `<tr>
                        <td>${att.attendanceDate}</td>
                        <td>${att.employeeName}</td>
                        <td>${formatTime(att.checkInTime)}</td>
                        <td>${formatTime(att.checkOutTime)}</td>
                        <td><span class="attendance-status status-${att.status}">${att.status}</span></td>
                        <td>${formatHours(att.totalHours)}</td>
                        <td>${att.notes || '-'}</td>
                        <td>
                            <button class="btn-info" onclick="editAttendance(${att.id})">Edit</button>
                            <button class="btn-danger" onclick="deleteAttendance(${att.id})">Delete</button>
                        </td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });
            }
        } catch (error) {
            showMessage('Failed to load attendance records', 'error');
        } finally {
            showLoading(false);
        }
    }

    // Quick attendance functions
    async function quickCheckIn() {
        const employeeId = document.getElementById('quickEmployeeSelect').value;
        if (!employeeId) {
            showMessage('Please select an employee', 'error');
            return;
        }

        await quickAttendanceAction(employeeId, 'checkin');
    }

    async function quickCheckOut() {
        const employeeId = document.getElementById('quickEmployeeSelect').value;
        if (!employeeId) {
            showMessage('Please select an employee', 'error');
            return;
        }

        await quickAttendanceAction(employeeId, 'checkout');
    }

    async function quickAttendanceAction(employeeId, action) {
        try {
            const response = await fetch(`${attendanceApiUrl}/quick`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    employeeId: parseInt(employeeId),
                    action: action
                })
            });

            const data = await response.json();

            if (!response.ok) {
                showMessage(data.error || `Failed to ${action}`, 'error');
                return;
            }

            showMessage(`${action === 'checkin' ? 'Check-in' : 'Check-out'} successful!`, 'success');
            loadAttendanceRecords();
        } catch (error) {
            showMessage(`Failed to ${action}`, 'error');
        }
    }

    // Attendance form handling
    document.getElementById('attendanceForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthenticated) return;

        const attendanceId = document.getElementById('attendanceId').value;
        const attendanceData = {
            employeeId: parseInt(document.getElementById('attendanceEmployee').value),
            attendanceDate: document.getElementById('attendanceDate').value,
            checkInTime: document.getElementById('checkInTime').value || null,
            checkOutTime: document.getElementById('checkOutTime').value || null,
            status: document.getElementById('attendanceStatus').value || null,
            notes: document.getElementById('attendanceNotes').value || null
        };

        if (!attendanceData.employeeId || !attendanceData.attendanceDate) {
            showMessage('Employee and date are required', 'error');
            return;
        }

        try {
            const url = attendanceId ? `${attendanceApiUrl}/${attendanceId}` : attendanceApiUrl;
            const method = attendanceId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers: getAuthHeaders(),
                body: JSON.stringify(attendanceData)
            });

            const data = await response.json();

            if (!response.ok) {
                showMessage(data.error || 'Failed to save attendance', 'error');
                return;
            }

            showMessage('Attendance saved successfully', 'success');
            document.getElementById('attendanceForm').reset();
            document.getElementById('attendanceId').value = '';
            document.getElementById('attendanceFormTitle').textContent = 'Mark Attendance';
            loadAttendanceRecords();
        } catch (error) {
            showMessage('Failed to save attendance', 'error');
        }
    });

    async function editAttendance(id) {
        try {
            const response = await fetch(`${attendanceApiUrl}/${id}`, {
                headers: getAuthHeaders()
            });

            const data = await response.json();

            if (!response.ok) {
                showMessage(data.error || 'Failed to load attendance', 'error');
                return;
            }

            document.getElementById('attendanceId').value = data.id;
            document.getElementById('attendanceEmployee').value = data.employeeId;
            document.getElementById('attendanceDate').value = data.attendanceDate;
            document.getElementById('checkInTime').value = formatTime(data.checkInTime) || '';
            document.getElementById('checkOutTime').value = formatTime(data.checkOutTime) || '';
            document.getElementById('attendanceStatus').value = data.status || '';
            document.getElementById('attendanceNotes').value = data.notes || '';
            document.getElementById('attendanceFormTitle').textContent = 'Update Attendance';
        } catch (error) {
            showMessage('Failed to load attendance for editing', 'error');
        }
    }

    async function deleteAttendance(id) {
        if (!confirm('Are you sure you want to delete this attendance record?')) return;

        try {
            const response = await fetch(`${attendanceApiUrl}/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                const data = await response.json();
                showMessage(data.error || 'Failed to delete attendance', 'error');
                return;
            }

            showMessage('Attendance record deleted successfully', 'success');
            loadAttendanceRecords();
        } catch (error) {
            showMessage('Failed to delete attendance', 'error');
        }
    }

    // Reports functionality
    async function generateReport() {
        const employeeId = document.getElementById('reportEmployee').value;
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;

        if (!employeeId) {
            showMessage('Please select an employee for the report', 'error');
            return;
        }

        if (!startDate || !endDate) {
            showMessage('Please select start and end dates', 'error');
            return;
        }

        if (new Date(startDate) > new Date(endDate)) {
            showMessage('Start date must be before end date', 'error');
            return;
        }

        showLoading(true);

        try {
            // Get attendance summary
            const summaryResponse = await fetch(`${attendanceApiUrl}/employee/${employeeId}/summary?startDate=${startDate}&endDate=${endDate}`, {
                headers: getAuthHeaders()
            });

            if (!summaryResponse.ok) {
                const data = await summaryResponse.json();
                showMessage(data.error || 'Failed to generate report', 'error');
                return;
            }

            const summary = await summaryResponse.json();

            // Get detailed attendance records
            const recordsResponse = await fetch(`${attendanceApiUrl}?startDate=${startDate}&endDate=${endDate}&employeeId=${employeeId}`, {
                headers: getAuthHeaders()
            });

            const records = recordsResponse.ok ? await recordsResponse.json() : [];

            displayReport(summary, records);

        } catch (error) {
            showMessage('Failed to generate report', 'error');
        } finally {
            showLoading(false);
        }
    }

    function displayReport(summary, records) {
        // Display statistics
        const statsContainer = document.getElementById('reportStats');
        statsContainer.innerHTML = `
            <div class="stat-card">
                <div class="stat-number">${summary.totalDays}</div>
                <div class="stat-label">Total Days</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${summary.presentDays}</div>
                <div class="stat-label">Present Days</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${summary.absentDays}</div>
                <div class="stat-label">Absent Days</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${summary.lateDays}</div>
                <div class="stat-label">Late Days</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${summary.halfDays}</div>
                <div class="stat-label">Half Days</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${summary.leaveDays}</div>
                <div class="stat-label">Leave Days</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${formatHours(summary.totalHours)}</div>
                <div class="stat-label">Total Hours</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${formatHours(summary.averageHours)}</div>
                <div class="stat-label">Avg Hours/Day</div>
            </div>
        `;

        // Display detailed records
        const tableBody = document.getElementById('reportTable');
        tableBody.innerHTML = '';

        if (records.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No attendance records found for the selected period.</td></tr>';
        } else {
            records.forEach(record => {
                const row = `<tr>
                    <td>${record.attendanceDate}</td>
                    <td>${formatTime(record.checkInTime)}</td>
                    <td>${formatTime(record.checkOutTime)}</td>
                    <td><span class="attendance-status status-${record.status}">${record.status}</span></td>
                    <td>${formatHours(record.totalHours)}</td>
                    <td>${record.notes || '-'}</td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }

        document.getElementById('reportResults').style.display = 'block';
    }

    // Initialize the application
    async function initialize() {
        const authResult = await checkAuth();
        if (authResult) {
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            const monthAgoStr = oneMonthAgo.toISOString().split('T')[0];

            document.getElementById('reportStartDate').value = monthAgoStr;
            document.getElementById('reportEndDate').value = today;

            // Load initial data
            await loadEmployees();
            await loadEmployeeOptions();
        }
    }

    // Start the application
    initialize();
</script>
</body>
</html>